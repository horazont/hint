# target config
TARGET = LPC11xx
FLASH = 32K
SRAM = 8K
DEBUG = FALSE

# paths and sources
ROOT = $(abspath .)
CODEBASEDIR = ./microbuilder-codebase
BIN = ./bin

VPATH = . $(CODEBASEDIR)
OBJS = src/main src/lcd src/utils src/font src/font_data src/draw \
		src/unicode
OBJS += lpc1xxx/LPC11xx_handlers lpc1xxx/LPC1xxx_startup
OBJS += core/uart/uart core/uart/uart_buf \
		core/cpu/cpu \
		core/systick/systick \
		core/gpio/gpio

# toolchain config
TARGET_TOOLCHAIN = arm-none-eabi-
AS = $(TARGET_TOOLCHAIN)as
CC = $(TARGET_TOOLCHAIN)gcc
LD = $(TARGET_TOOLCHAIN)gcc
SIZE = $(TARGET_TOOLCHAIN)size
OBJCOPY = $(TARGET_TOOLCHAIN)objcopy
OBJDUMP = $(TARGET_TOOLCHAIN)objdump
GENFONT = utils/genfont.py

# flags
INCLUDE_PATHS = -I$(ROOT) -I$(CODEBASEDIR)/core -I$(CODEBASEDIR) -I$(ROOT)/inc

# linker stuff
LD_SCRIPT = $(CODEBASEDIR)/lpc1xxx/linkscript.ld
LD_TEMP = $(BIN)/memory.ld
CPU_TYPE = cortex-m0

BASEFLAGS = -Wall -Wextra -Werror
OPTFLAGS = -Os

ifeq (TRUE,$(DEBUG))
    COMMONFLAGS = -c -g -O0 $(INCLUDE_PATHS) $(BASEFLAGS) -mthumb \
        -ffunction-sections -fdata-sections -fmessage-length=0 \
        -mcpu=$(CPU_TYPE)
    CFLAGS = $(COMMONFLAGS) -DTARGET=$(TARGET) -fno-builtin
    ASFLAGS = $(COMMONFLAGS) -D__ASSEMBLY__ -x assembler-with-cpp
else
    COMMONFLAGS = -c -g $(OPTFLAGS) $(INCLUDE_PATHS) $(BASEFLAGS) \
        -mthumb -ffunction-sections -fdata-sections -fmessage-length=0 \
        -mcpu=$(CPU_TYPE)
    CFLAGS = $(COMMONFLAGS) -DTARGET=$(TARGET) -fno-builtin
    ASFLAGS = $(COMMONFLAGS) -D__ASSEMBLY__ -x assembler-with-cpp
endif

CFLAGS += -std=c11
LDFLAGS = -nostartfiles -mcpu=$(CPU_TYPE) -mthumb -Wl,--gc-sections
LDLIBS = -lm
OCFLAGS = --strip-unneeded

# autogenerated
OBJ_FILES = $(addprefix bin/,$(addsuffix .o,$(OBJS)))
SRC_FILES = $(addsuffix .c,$(OBJS))
FIRMWAREBASE = bin/firmware
FAKEDEPS = inc/lpc111x.h inc/projectconfig.h inc/sysdefs.h
# make all files depend on project config
COMMONDEPS = src/config.h

default: bin/firmware.hex

inc/lpc111x.h:
	ln -s ../$(CODEBASEDIR)/lpc111x.h $@

inc/sysdefs.h:
	ln -s ../$(CODEBASEDIR)/sysdefs.h $@

inc/projectconfig.h:
	ln -s ../src/config.h $@

src/cantarell.inc: $(GENFONT)
	$(GENFONT) \
		-r 0x20 0x7e \
		-r 0xa1 0xff \
		-x 0xad \
		-- \
		Cantarell 0.9 cantarell > $@

$(FIRMWAREBASE).elf: $(OBJ_FILES) $(FAKEDEPS) $(COMMONDEPS)
	-@echo "MEMORY" > $(LD_TEMP)
	-@echo "{" >> $(LD_TEMP)
	-@echo "  flash(rx): ORIGIN = 0x00000000, LENGTH = $(FLASH)" >> $(LD_TEMP)
	-@echo "  sram(rwx): ORIGIN = 0x10000000, LENGTH = $(SRAM)" >> $(LD_TEMP)
	-@echo "}" >> $(LD_TEMP)
	-@echo "INCLUDE $(LD_SCRIPT)" >> $(LD_TEMP)
	$(LD) $(LDFLAGS) -T $(LD_TEMP) -o $@ $(OBJ_FILES) $(LDLIBS)
	$(SIZE) $@

$(FIRMWAREBASE).hex: $(FIRMWAREBASE).elf
	$(OBJCOPY) $(OCFLAGS) -O ihex $< $@

bin/src/font_data.o: src/font_data.c src/font.h src/font_data.h src/cantarell.inc
	@mkdir -p $(dir $@)
	$(CC) $(CFLAGS) -o $@ $<

bin/%.o: %.c %.h $(FAKEDEPS) $(COMMONDEPS)
	@mkdir -p $(dir $@)
	$(CC) $(CFLAGS) -o $@ $<

bin/%.o: %.c $(FAKEDEPS) $(COMMONDEPS)
	@mkdir -p $(dir $@)
	$(CC) $(CFLAGS) -o $@ $<

bin/%.o: %.s $(FAKEDEPS) $(COMMONDEPS)
	@mkdir -p $(dir $@)
	$(AS) $(ASFLAGS) -o $@ $<

clean:
	rm -f $(FAKEDEPS) src/cantarell.inc
	rm -rf bin
	mkdir bin

.PHONY: clean
